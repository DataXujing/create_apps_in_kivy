<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="徐静">
  <link rel="shortcut icon" href="../icon.ico">
  
  <title>第十章 总结及项目展示 - Python Kivy创建Apps</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "\u7b2c\u5341\u7ae0 \u603b\u7ed3\u53ca\u9879\u76ee\u5c55\u793a";
    var mkdocs_page_input_path = "chapter10.md";
    var mkdocs_page_url = "/chapter10/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../about/" class="icon icon-home"> Python Kivy创建Apps</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../about/">关于</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="..">前言</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../chapter1/">第一章 Kivy简介</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../chapter2/">第二章 涂鸦画板项目基于kivy实现</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../chapter3/">第三章 涂鸦画板项目基于kivymd实现</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../chapter4/">第四章 智能车道线检测项目(基于Kivy)</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../chapter5/">第五章 基于生成对抗网络(GAN)的一键现实转换二次元动画场景迁移项目(基于Kivymd)</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../chapter6/">第六章 pyinstaller打包Windows桌面应用程序</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../chapter7/">第七章 setupfactory安装程序打包</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../chapter8/">第八章 p4a Android打包基于kivy的涂鸦画板项目</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../chapter9/">第九章 buildozer Android打包基于kivymd的涂鸦画板项目</a>
	    </li>
          
            <li class="toctree-l1 current">
		
    <a class="current" href="./">第十章 总结及项目展示</a>
    <ul class="subnav">
            
    <li class="toctree-l2"><a href="#_1">第十章 总结加项目展示</a></li>
    
        <ul>
        
            <li><a class="toctree-l3" href="#_2">最后的作业</a></li>
        
            <li><a class="toctree-l3" href="#pyqt5ai">附件： 基于PyQt5的AI京剧换脸软件的源码和演示</a></li>
        
        </ul>
    

    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../about/">Python Kivy创建Apps</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../about/">Docs</a> &raquo;</li>
    
      
    
    <li>第十章 总结及项目展示</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/DataXujing/create_apps_in_kivy/edit/master/docs/chapter10.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h2 id="_1">第十章 总结加项目展示</h2>
<hr />
<p>本课程中我们主要涉及到了4个项目：</p>
<ul>
<li>基于PyQt5的AI京剧换脸软件开发</li>
<li>基于kivy(kivymd)的涂鸦画板软件开发</li>
<li>基于kivy的智能车道线检测APP开发</li>
<li>基于kivymd的GAN一键现实转二次元动画场景迁移APP开发</li>
</ul>
<p>我们详细的分步骤介绍了每个项目的开发过程及在windows和android下的打包过程，最后我们在本次课将详细的演示我们上述涉及的项目在安卓手机的演示。</p>
<p><strong>手机桌面</strong>
<div align=center>
<img src="../img/ch10/p1.jpg" width=300 /> 
</div>
<br></p>
<p><strong>涂鸦画板</strong></p>
<div align=center>
<img src="../img/ch10/p2.jpg" width=700 /> 
</div>

<p><br></p>
<p><strong>涂鸦画板md</strong></p>
<div align=center>
<img src="../img/ch10/p3.jpg" width=300 /> 
</div>

<p><br></p>
<p><strong>智能车道线检测</strong></p>
<div align=center>
<img src="../img/ch10/p4.jpg" width=300 /> 
</div>

<p><br></p>
<p><strong>GAN风格迁移</strong></p>
<div align=center>
<img src="../img/ch10/p5.jpg" width=300 /> 
</div>

<p><br></p>
<h3 id="_2">最后的作业</h3>
<p>基于kivy和kivymd实现二维码扫描识别的安卓应用！</p>
<div align=center>
<img src="../img/ch10/qr_app.png" /> 
</div>

<h3 id="pyqt5ai">附件： 基于PyQt5的AI京剧换脸软件的源码和演示</h3>
<p>为了展示PyQt5与Kivy的区别和联系，我们在最后附上基于PyQt5的AI京剧换脸的软件开发的源码和最后在Windows打包后的运行演示。</p>
<p>该项目开源地址<a href="https://github.com/DataXujing/AI-Face-changing-in-Peking-Opera-">https://github.com/DataXujing/AI-Face-changing-in-Peking-Opera-</a>欢迎star和fork!!!</p>
<p>基于PyQt5的AI京剧换脸项目列表：</p>
<div align=center>
<img src="../img/ch10/p6.png" /> 
</div>

<p>这里：</p>
<ul>
<li>pb文件夹存放了tensorflow训练的人脸检测模型mtcnn</li>
<li>static文件夹存放了项目需要的图像等静态资源文件</li>
<li><code>__init__.py</code>是包文件</li>
<li><code>mtcmm.py</code>是人脸检测模型的调用</li>
<li><code>my_main_ui.py</code>是槽函数</li>
<li><code>my_main_ui.spec</code>是pyinstaller打包的配置文件</li>
<li><code>,y_main_ui_gpu.spec</code>是pyinstaller打包的配置文件(在GPU下)</li>
<li><code>my_pic.qrc，my_pic.py</code>是编译的二进制静态资源文件</li>
<li><code>README.md</code>是项目的说明文档</li>
<li><code>Ui_my_main_ui.py</code>是PyQt5的UI文件</li>
</ul>
<p>我们就按照上述顺序，对涉及到的主要py文件进行展示</p>
<ul>
<li><code>mtcnn.py</code></li>
</ul>
<pre><code class="python">import argparse

import tensorflow as tf
import cv2


# tensorflow = 1.9.0
class MTCNN:

    def __init__(self, model_path, min_size=40, factor=0.709, thresholds=[0.6, 0.7, 0.7]):
        self.min_size = min_size
        self.factor = factor
        self.thresholds = thresholds

        graph = tf.Graph()
        with graph.as_default():
            with open(model_path, 'rb') as f:
                graph_def = tf.GraphDef.FromString(f.read())
                tf.import_graph_def(graph_def, name='')
        self.graph = graph
        config = tf.ConfigProto(
            allow_soft_placement=True,
            intra_op_parallelism_threads=4,
            inter_op_parallelism_threads=4)
        config.gpu_options.allow_growth = True
        self.sess = tf.Session(graph=graph, config=config)

    def detect(self, img):
        feeds = {
            self.graph.get_operation_by_name('input').outputs[0]: img,
            self.graph.get_operation_by_name('min_size').outputs[0]: self.min_size,
            self.graph.get_operation_by_name('thresholds').outputs[0]: self.thresholds,
            self.graph.get_operation_by_name('factor').outputs[0]: self.factor
        }
        fetches = [self.graph.get_operation_by_name('prob').outputs[0],
                  self.graph.get_operation_by_name('landmarks').outputs[0],
                  self.graph.get_operation_by_name('box').outputs[0]]
        prob, landmarks, box = self.sess.run(fetches, feeds)
        return box, prob, landmarks


def main(args):
    mtcnn = MTCNN('./pb/mtcnn.pb')
    img = cv2.imread(args.image)

    bbox, scores, landmarks = mtcnn.detect(img)

    print('total box:', len(bbox))
    for box, pts in zip(bbox, landmarks):
        box = box.astype('int32')
        img = cv2.rectangle(img, (box[1], box[0]), (box[3], box[2]), (255, 0, 0), 3)

        pts = pts.astype('int32')
        for i in range(5):
            img = cv2.circle(img, (pts[i+5], pts[i]), 1, (0, 255, 0), 2)
    cv2.imshow('image', img)
    cv2.waitKey(0)


if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='tensorflow mtcnn')
    parser.add_argument('image', help='image path')
    args = parser.parse_args()
    main(args)


</code></pre>

<ul>
<li><code>my_main_ui.py</code></li>
</ul>
<pre><code class="python"># -*- coding: utf-8 -*-

&quot;&quot;&quot;
xujing
2020-06-17
mainwindow
&quot;&quot;&quot;

import PyQt5.QtCore
from PyQt5.QtCore import pyqtSlot
from PyQt5.QtWidgets import QMainWindow

from Ui_my_main_ui import Ui_MainWindow

from PyQt5.QtCore import *
from PyQt5.QtWidgets import  *
from PyQt5 import *
from PyQt5.QtGui import *
import sys
import time

import cv2
import numpy as np
from PIL import Image
from mtcnn import MTCNN
from numba import jit, prange

# import qdarkstyle
# dark_stylesheet = qdarkstyle.load_stylesheet_pyqt5()


# 仿射变换，用于将贴图点映射到人脸点,得到变换矩阵M
def get_text_trans_matrix(x1, y1, x2, y2, x3, y3, tx1, ty1, tx2, ty2, tx3, ty3):
    '''
    src：原始图像中的三个点的坐标
    dst：变换后的这三个点对应的坐标
    M：根据三个对应点求出的仿射变换矩阵2X3
    '''
    # 放射变换
    return cv2.getAffineTransform( np.float32([ [tx1, ty1], [tx2, ty2], [tx3, ty3] ]), np.float32( [ [x1, y1], [x2, y2], [x3, y3] ]) ).flatten() # 按行拉直
    # 透视变换
    # return cv2.getPerspectiveTransform( np.float32([ [tx1, ty1], [tx2, ty2], [tx3, ty3] ]), np.float32( [ [x1, y1], [x2, y2], [x3, y3] ]) ).flatten()

@jit(nopython=True)
def sticker(srcData, width, height, stride, mask, maskWidth, maskHeight, maskStride, srcFacePoints, maskFacePoints, H):
    def CLIP3(x, a, b):
        return min(max(a,x), b)
    # 用于将贴图点映射到人脸点 
    for i in range(height):
    # for i in prange(height):
        for j in range(width):
            x = float(i)
            y = float(j)
            tx = (int)((H[0] * (x)+H[1] * (y)+H[2]) + 0.5)
            ty = (int)((H[3] * (x)+H[4] * (y)+H[5]) + 0.5)
            tx = CLIP3(tx, 0, maskHeight - 1)
            ty = CLIP3(ty, 0, maskWidth - 1)

            mr = int( mask[ int(tx), int(ty), 0 ] ) 
            mg = int( mask[ int(tx), int(ty), 1 ] ) 
            mb = int( mask[ int(tx), int(ty), 2 ] ) 
            alpha = int( mask[ int(tx), int(ty), 3 ] )  
            #if alpha!=0:
            #    print( '&gt;&gt;&gt;', alpha )
            b = srcData[i, j, 0]
            g = srcData[i, j, 1]
            r = srcData[i, j, 2]        
            srcData[i, j, 0] =CLIP3((b * (255 - alpha) + mb * alpha) / 255, 0, 255)
            srcData[i, j, 1] =CLIP3((g * (255 - alpha) + mg * alpha) / 255, 0, 255)
            srcData[i, j, 2] =CLIP3((r * (255 - alpha) + mr * alpha) / 255, 0, 255)
    return srcData


# @jit(parallel=True,nogil=True)
# @njit(parallel=True,nogil=True)
def trent_sticker(srcData, width, height, stride, mask, maskWidth, maskHeight, maskStride, srcFacePoints, maskFacePoints, ratio):
    ret = 0
    H = get_text_trans_matrix( maskFacePoints[0], maskFacePoints[1],maskFacePoints[2],maskFacePoints[3],maskFacePoints[4],maskFacePoints[5], srcFacePoints[0], srcFacePoints[1],srcFacePoints[2],srcFacePoints[3],srcFacePoints[4],srcFacePoints[5] )
    #print ('H', H) 
    srcData = sticker(srcData, width, height, stride, mask, maskWidth, maskHeight, maskStride, srcFacePoints, maskFacePoints, H)
    return srcData, ret 

# 京剧脸谱配置
face_key_point = {
    &quot;01&quot;: [ 958.0,599.0, 958.0,1083.0, 1516.0,838.0 ],
    &quot;02&quot;: [ 182.0,155.0, 182.0,243.0, 290.0,199.0 ],
    &quot;03&quot;: [ 249.0,224.0, 247.0,342.0, 392.0,247.0 ],
    &quot;04&quot;: [ 232.0,136.0, 232.0,267.0, 378.0,200.0 ],
    &quot;05&quot;: [ 241.0,189.0, 241.0,323.0, 405.0,253.0 ],
    &quot;06&quot;: [ 237.0,159.0, 237.0,284.0, 381.0,213.0 ],
    &quot;07&quot;: [ 256.0,219.0, 256.0,342.0, 405.0,281.0 ],
    &quot;08&quot;: [ 217.0,185.0, 217.0,298.0, 356.0,243.0 ],
    &quot;09&quot;: [ 391.0,223.0, 391.0,428.0, 652.0,324.0 ],
    &quot;10&quot;: [ 197.0,203.0, 197.0,313.0, 329.0,249.0 ],
    &quot;11&quot;: [ 153.0,98.0, 153.0,164.0, 232.0,129.0 ],
    &quot;12&quot;: [ 248.0,216.0, 248.0,345.0, 402.0,280.0 ],
    &quot;13&quot;: [ 264.0,177.0, 264.0,325.0, 459.0,252.0 ],
    &quot;14&quot;: [ 290.0,171.0, 290.0,333.0, 478.0,250.0 ],
    &quot;15&quot;: [ 154.0,105.0, 154.0,196.0, 271.0,149.0]
    }


class MainWindow(QMainWindow, Ui_MainWindow):
    &quot;&quot;&quot;
    Class documentation goes here.
    &quot;&quot;&quot;
    def __init__(self, parent=None):
        &quot;&quot;&quot;
        Constructor

        @param parent reference to the parent widget
        @type QWidget
        &quot;&quot;&quot;
        super(MainWindow, self).__init__(parent)
        self.setupUi(self)

        self.left_button = 0
        self.right_button = 4
        QToolTip.setFont(QFont('SansSerif', 40))

        self.my_face_choose = &quot;01&quot;
        self.label.mylabelSig.connect(self.label_choose)
        self.label_2.mylabelSig.connect(self.label_2_choose)
        self.label_3.mylabelSig.connect(self.label_3_choose)
        self.label_4.mylabelSig.connect(self.label_4_choose)



    def label_choose(self):
        # self.label.setStyleSheet(&quot;&quot;)
        self.label_2.setText(&quot;&quot;)
        self.label_3.setText(&quot;&quot;)
        self.label_4.setText(&quot;&quot;)

        pe = QPalette()
        pe.setColor(QPalette.WindowText,Qt.green)#设置字体颜色
        self.label.setPalette(pe)

        self.label.setAlignment(Qt.AlignCenter)
        self.label.setFont(QFont(&quot;Roman times&quot;,20,QFont.Bold))

        try:
            self.label.setText(&quot;&lt;b&gt;选择: %02d&lt;/b&gt;&quot;%self.face_1[0])
            self.my_face_choose = &quot;%02d&quot;%self.face_1[0]
        except:
            self.label.setText(&quot;&lt;b&gt;选择: 01&lt;/b&gt;&quot;)

    def label_2_choose(self):
        # self.label.setStyleSheet(&quot;&quot;)
        self.label.setText(&quot;&quot;)
        self.label_3.setText(&quot;&quot;)
        self.label_4.setText(&quot;&quot;)

        pe = QPalette()
        pe.setColor(QPalette.WindowText,Qt.green)#设置字体颜色
        self.label_2.setPalette(pe)

        self.label_2.setAlignment(Qt.AlignCenter)
        self.label_2.setFont(QFont(&quot;Roman times&quot;,20,QFont.Bold))

        try:
            self.label_2.setText(&quot;&lt;b&gt;选择: %02d&lt;/b&gt;&quot;%self.face_2[0])
            self.my_face_choose = &quot;%02d&quot;%self.face_2[0]
        except:
            self.label_2.setText(&quot;&lt;b&gt;选择: 02&lt;/b&gt;&quot;)
            self.my_face_choose = &quot;02&quot;

    def label_3_choose(self):
        # self.label.setStyleSheet(&quot;&quot;)
        self.label_2.setText(&quot;&quot;)
        self.label.setText(&quot;&quot;)
        self.label_4.setText(&quot;&quot;)

        pe = QPalette()
        pe.setColor(QPalette.WindowText,Qt.green)#设置字体颜色
        self.label_3.setPalette(pe)

        self.label_3.setAlignment(Qt.AlignCenter)
        self.label_3.setFont(QFont(&quot;Roman times&quot;,20,QFont.Bold))

        try:
            self.label_3.setText(&quot;&lt;b&gt;选择: %02d&lt;/b&gt;&quot;%self.face_3[0])
            self.my_face_choose = &quot;%02d&quot;%self.face_3[0]
        except:
            self.label_3.setText(&quot;&lt;b&gt;选择: 03&lt;/b&gt;&quot;)
            self.my_face_choose = &quot;03&quot;

    def label_4_choose(self):
        # self.label.setStyleSheet(&quot;&quot;)
        self.label_2.setText(&quot;&quot;)
        self.label_3.setText(&quot;&quot;)
        self.label.setText(&quot;&quot;)

        pe = QPalette()
        pe.setColor(QPalette.WindowText,Qt.green)#设置字体颜色
        self.label_4.setPalette(pe)

        self.label_4.setAlignment(Qt.AlignCenter)
        self.label_4.setFont(QFont(&quot;Roman times&quot;,20,QFont.Bold))

        try:
            self.label_4.setText(&quot;&lt;b&gt;选择: %02d&lt;/b&gt;&quot;%self.face_4[0])
            self.my_face_choose = &quot;%02d&quot;%self.face_4[0]
        except:
            self.label_4.setText(&quot;&lt;b&gt;选择: 04&lt;/b&gt;&quot;)
            self.my_face_choose = &quot;04&quot;




    @pyqtSlot()
    def on_pushButton_clicked(self):
        &quot;&quot;&quot;
        左翻页
        &quot;&quot;&quot;

        if self.right_button == 4:
            self.left_button += 1

            self.face_1 = [self.left_button+1 if self.left_button &lt;= 11 else 12]
            self.face_2 = [self.left_button+2 if self.left_button &lt;= 12 else 13]
            self.face_3 = [self.left_button+3 if self.left_button &lt;= 13 else 14]
            self.face_4 = [self.left_button+4 if self.left_button &lt;= 14 else 15]
        else:
            self.face_1 = [self.face_1[0]+1]
            self.face_2 = [self.face_2[0]+1]
            self.face_3 = [self.face_3[0]+1]
            self.face_4 = [self.face_4[0]+1]


        self.label.setStyleSheet(&quot;border-image: url(:/my_pic/pic/mask/%02d.png);&quot;%self.face_1[0])
        self.label_2.setStyleSheet(&quot;border-image: url(:/my_pic/pic/mask/%02d.png);&quot;%self.face_2[0])
        self.label_3.setStyleSheet(&quot;border-image: url(:/my_pic/pic/mask/%02d.png);&quot;%self.face_3[0])
        self.label_4.setStyleSheet(&quot;border-image: url(:/my_pic/pic/mask/%02d.png);&quot;%self.face_4[0])

        self.label.setToolTip(&quot;&lt;b&gt;%02d&lt;/b&gt;&quot;%self.face_1[0])
        self.label_2.setToolTip(&quot;&lt;b&gt;%02d&lt;/b&gt;&quot;%self.face_2[0])
        self.label_3.setToolTip(&quot;&lt;b&gt;%02d&lt;/b&gt;&quot;%self.face_3[0])
        self.label_4.setToolTip(&quot;&lt;b&gt;%02d&lt;/b&gt;&quot;%self.face_4[0])

    @pyqtSlot()
    def on_pushButton_2_clicked(self):
        &quot;&quot;&quot;
        &quot;右翻页&quot;
        &quot;&quot;&quot;

        if self.left_button == 0:
            self.right_button += 1

            self.face_1 = [self.right_button-4 if self.right_button &gt; 4 else 1]
            self.face_2 = [self.right_button-3 if self.right_button &gt; 3 else 2]
            self.face_3 = [self.right_button-2 if self.right_button &gt; 2 else 3]
            self.face_4 = [self.right_button-1 if self.right_button &gt; 1 else 4]
        else:
            self.face_1 = [self.face_1[0]-1]
            self.face_2 = [self.face_2[0]-1]
            self.face_3 = [self.face_3[0]-1]
            self.face_4 = [self.face_4[0]-1]


        self.label.setStyleSheet(&quot;border-image: url(:/my_pic/pic/mask/%02d.png);&quot;%self.face_1[0])
        self.label_2.setStyleSheet(&quot;border-image: url(:/my_pic/pic/mask/%02d.png);&quot;%self.face_2[0])
        self.label_3.setStyleSheet(&quot;border-image: url(:/my_pic/pic/mask/%02d.png);&quot;%self.face_3[0])
        self.label_4.setStyleSheet(&quot;border-image: url(:/my_pic/pic/mask/%02d.png);&quot;%self.face_4[0])

        self.label.setToolTip(&quot;&lt;b&gt;%02d&lt;/b&gt;&quot;%self.face_1[0])
        self.label_2.setToolTip(&quot;&lt;b&gt;%02d&lt;/b&gt;&quot;%self.face_2[0])
        self.label_3.setToolTip(&quot;&lt;b&gt;%02d&lt;/b&gt;&quot;%self.face_3[0])
        self.label_4.setToolTip(&quot;&lt;b&gt;%02d&lt;/b&gt;&quot;%self.face_4[0])



    @pyqtSlot()
    def on_pushButton_3_clicked(self):
        &quot;&quot;&quot;
        AI人脸识别 + 仿射变换
        &quot;&quot;&quot;
        jingju = self.my_face_choose
        self.my_face_choose = &quot;01&quot;
        self.label.setText(&quot;&quot;)
        self.label_2.setText(&quot;&quot;)
        self.label_3.setText(&quot;&quot;)
        self.label_4.setText(&quot;&quot;)
        print(jingju)

        img = Image.open(&quot;./static/{}.png&quot;.format(jingju)) 

        r,g,b,a=img.split()   #分离4通道 
        im_array = np.array(img) 
        # 高宽通道 (坐标取值为y, x) 
        mask_h, mask_w, mask_c = im_array.shape 

        try:
            # img = cv2.imread( './test_img/001.jpg' )
            openfile_name = QFileDialog.getOpenFileName(self,'AI京剧换脸','','JPEG Files(*.jpg);;PNG Files(*.png);;PGM Files(*.pgm)')

            img = cv2.imread( openfile_name[0] )
            # 高宽通道 (坐标取值为y, x)
            h, w, c = img.shape
            bbox, scores, landmarks = mtcnn.detect(img)

            for box, pts in zip(bbox, landmarks):
                faceInfos = np.array( [ 1, box[1], box[0], box[3] - box[1], box[2] - box[0], pts[5], pts[0], pts[6], pts[1], pts[7], pts[2], pts[8], pts[3], pts[9], pts[4] ] )


            srcFacePoints = np.array( [faceInfos[6], faceInfos[5], faceInfos[8], faceInfos[7], (faceInfos[12]+faceInfos[14])/2.0, (faceInfos[11] + faceInfos[13])/2.0 ] ) 
            print ('srcFacePoints:', srcFacePoints) 


            maskFacePoints = np.array(face_key_point[jingju]) 
            print ('maskFacePoints:', maskFacePoints)

            # start_time = time.time()
            srcData, ret  = trent_sticker( img, w, h, 3, im_array, mask_w, mask_h, 4, srcFacePoints, maskFacePoints, 100 ) 
            # print ( 'time &gt;&gt;&gt;&gt;', time.time() - start_time )
            img_mask = np.array(srcData, dtype=np.uint8) 
            # cv2.imwrite('res.jpg', img_mask)

            bytesPerLine = c * w

            cv2.cvtColor(img, cv2.COLOR_BGR2RGB, img)
            QImg = QImage(img.data, w, h,bytesPerLine, QImage.Format_RGB888)
            self.label_6.setAlignment(Qt.AlignCenter)
            self.label_6.setPixmap(QPixmap.fromImage(QImg).scaled(self.label_6.size(), Qt.KeepAspectRatio, Qt.SmoothTransformation))

            self.save_img = cv2.cvtColor(img, cv2.COLOR_RGB2BGR)
        except Exception as e:
            print(e)



    @pyqtSlot()
    def on_pushButton_5_clicked(self):
        &quot;&quot;&quot;
        TODO: 视频流
        &quot;&quot;&quot;

        QMessageBox.information(self,
                                    &quot;AI京剧换脸 消息&quot;,  
                                    &quot;目前不提供视频应用！&quot;,  
                                    QMessageBox.Yes | QMessageBox.No)

    @pyqtSlot()
    def on_pushButton_4_clicked(self):
        &quot;&quot;&quot;
        下载图像
        &quot;&quot;&quot;

        try:
            filename=QFileDialog.getSaveFileName(self,'AI京剧换脸 保存','','JPEG Files(*.jpg);;PNG Files(*.png);;PGM Files(*.pgm)')
            cv2.imwrite(filename[0],self.save_img)
        except:
            QMessageBox.warning(self,
                                    &quot;AI京剧换脸 警告&quot;,  
                                    &quot;没有需要下载保存的图片！&quot;,  
                                    QMessageBox.Yes | QMessageBox.No)



if __name__ == &quot;__main__&quot;:

    app = QtWidgets.QApplication(sys.argv)
    # app.setStyleSheet(dark_stylesheet)

    splash = QSplashScreen(QtGui.QPixmap(':/my_pic/pic/face.png'))
    # splash = MySplashScreen('./pic/face.gif', Qt.WindowStaysOnTopHint)
    splash.show()
    splash.showMessage('渲染界面...')
    # QThread.sleep(0.5)
    time.sleep(0.5)
    splash.showMessage('正在初始化程序...')
    mtcnn = MTCNN('./pb/mtcnn.pb')   # 实例化MTCNN
    app. processEvents()
    ui =MainWindow()
    ui.show()
    splash.finish(ui)
    sys.exit(app.exec_())

</code></pre>

<ul>
<li><code>my_mian_ui.spec</code></li>
</ul>
<pre><code>
# -*- mode: python ; coding: utf-8 -*-

import sys
sys.setrecursionlimit(5000)

block_cipher = None


a = Analysis(['my_main_ui.py'],
             pathex=['C:\\Users\\xujing.LAPTOP-LLR84L1D\\Desktop\\Face_AI'],
             binaries=[],
             datas=[],
             hiddenimports=[],
             hookspath=[],
             runtime_hooks=[],
             excludes=[],
             win_no_prefer_redirects=False,
             win_private_assemblies=False,
             cipher=block_cipher,
             noarchive=False)
pyz = PYZ(a.pure, a.zipped_data,
             cipher=block_cipher)
exe = EXE(pyz,
          a.scripts,
          [],
          exclude_binaries=True,
          name='my_main_ui',
          debug=False,
          bootloader_ignore_signals=False,
          strip=False,
          upx=True,
          console=False , icon='icon.ico')
coll = COLLECT(exe,
               a.binaries,
               a.zipfiles,
               a.datas,
               strip=False,
               upx=True,
               upx_exclude=[],
               name='my_main_ui')

</code></pre>

<ul>
<li><code>Ui_my_main_ui.py</code></li>
</ul>
<pre><code class="python">

# -*- coding: utf-8 -*-

'''
Created by: PyQt5 UI code generator 5.15.0

xujing
2020-06-17
ui mainwindow
'''

from PyQt5 import QtCore, QtGui, QtWidgets

from PyQt5 import QtCore, QtGui, QtWidgets
from PyQt5.QtGui import *
from PyQt5.QtCore import *
import sys

from PyQt5.QtWidgets import QLabel
from PyQt5.QtCore import pyqtSignal


class MyLabel(QLabel):
    '''
    重写label，增加单击的信号函数
    '''
    mylabelSig = pyqtSignal(str)
    # mylabelDoubleClickSig = pyqtSignal(str)

    def __int__(self):
        super(MyLabel, self).__init__()

    def mousePressEvent(self, e):    # 单击
        sigContent = self.objectName()
        self.mylabelSig.emit(sigContent)

class Ui_MainWindow(object):
    def setupUi(self, MainWindow):
        button_style = ''' 
         QPushButton
         {text-align : center;
         background-color : white;
         font: bold;
         border-color: gray;
         border-width: 2px;
         border-radius: 10px;
         padding: 6px;
         height : 14px;
         border-style: outset;
         font : 14px;}
         QPushButton:pressed
         {text-align : center;
         background-color : light gray;
         font: bold;
         border-color: gray;
         border-width: 2px;
         border-radius: 10px;
         padding: 6px;
         height : 14px;
         border-style: outset;
         font : 14px;}
        '''

        MainWindow.setObjectName(&quot;MainWindow&quot;)
        MainWindow.resize(967, 787)
        icon = QtGui.QIcon()
        icon.addPixmap(QtGui.QPixmap(&quot;:/my_pic/pic/脸谱.png&quot;), QtGui.QIcon.Normal, QtGui.QIcon.Off)
        MainWindow.setWindowIcon(icon)
        self.centralWidget = QtWidgets.QWidget(MainWindow)
        self.centralWidget.setObjectName(&quot;centralWidget&quot;)
        self.gridLayout = QtWidgets.QGridLayout(self.centralWidget)
        self.gridLayout.setObjectName(&quot;gridLayout&quot;)
        self.horizontalLayout = QtWidgets.QHBoxLayout()
        self.horizontalLayout.setObjectName(&quot;horizontalLayout&quot;)
        self.pushButton = QtWidgets.QPushButton(self.centralWidget)
        self.pushButton.setMinimumSize(QtCore.QSize(149, 200))
        self.pushButton.setStyleSheet(&quot;border-image: url(:/my_pic/pic/左翻页.png);&quot;)
        self.pushButton.setText(&quot;&quot;)
        self.pushButton.setObjectName(&quot;pushButton&quot;)
        self.horizontalLayout.addWidget(self.pushButton)
        # self.label = QtWidgets.QLabel(self.centralWidget)
        self.label = MyLabel()
        self.label.setMinimumSize(QtCore.QSize(131, 179))
        self.label.setMaximumSize(QtCore.QSize(262, 682))
        self.label.setStyleSheet(&quot;border-image: url(:/my_pic/pic/mask/01.png);&quot;)
        self.label.setText(&quot;&quot;)
        self.label.setObjectName(&quot;label&quot;)
        self.horizontalLayout.addWidget(self.label)
        # self.label_2 = QtWidgets.QLabel(self.centralWidget)
        self.label_2 = MyLabel()
        self.label_2.setMaximumSize(QtCore.QSize(298, 682))
        self.label_2.setStyleSheet(&quot;border-image: url(:/my_pic/pic/mask/02.png);&quot;)
        self.label_2.setText(&quot;&quot;)
        self.label_2.setObjectName(&quot;label_2&quot;)
        self.horizontalLayout.addWidget(self.label_2)
        # self.label_3 = QtWidgets.QLabel(self.centralWidget)
        self.label_3 = MyLabel()
        self.label_3.setMaximumSize(QtCore.QSize(298, 682))
        self.label_3.setStyleSheet(&quot;border-image: url(:/my_pic/pic/mask/03.png);&quot;)
        self.label_3.setText(&quot;&quot;)
        self.label_3.setObjectName(&quot;label_3&quot;)
        self.horizontalLayout.addWidget(self.label_3)
        # self.label_4 = QtWidgets.QLabel(self.centralWidget)
        self.label_4 = MyLabel()
        self.label_4.setMaximumSize(QtCore.QSize(298, 682))
        self.label_4.setStyleSheet(&quot;border-image: url(:/my_pic/pic/mask/04.png);&quot;)
        self.label_4.setText(&quot;&quot;)
        self.label_4.setObjectName(&quot;label_4&quot;)
        self.horizontalLayout.addWidget(self.label_4)
        self.pushButton_2 = QtWidgets.QPushButton(self.centralWidget)
        self.pushButton_2.setMinimumSize(QtCore.QSize(149, 200))
        self.pushButton_2.setStyleSheet(&quot;border-image: url(:/my_pic/pic/右翻页.png);&quot;)
        self.pushButton_2.setText(&quot;&quot;)
        self.pushButton_2.setObjectName(&quot;pushButton_2&quot;)
        self.horizontalLayout.addWidget(self.pushButton_2)
        self.gridLayout.addLayout(self.horizontalLayout, 0, 0, 1, 3)
        self.line = QtWidgets.QFrame(self.centralWidget)
        self.line.setFrameShape(QtWidgets.QFrame.HLine)
        self.line.setFrameShadow(QtWidgets.QFrame.Sunken)
        self.line.setObjectName(&quot;line&quot;)
        self.gridLayout.addWidget(self.line, 1, 0, 1, 3)
        self.label_6 = QtWidgets.QLabel(self.centralWidget)
        self.label_6.setMaximumSize(QtCore.QSize(1882, 684))
        self.label_6.setStyleSheet(&quot;image: url(:/my_pic/pic/face.png);&quot;)
        self.label_6.setText(&quot;&quot;)
        self.label_6.setObjectName(&quot;label_6&quot;)
        self.gridLayout.addWidget(self.label_6, 2, 0, 1, 3)
        self.pushButton_3 = QtWidgets.QPushButton(self.centralWidget)
        self.pushButton_3.setStyleSheet(button_style)
        self.pushButton_3.setMinimumSize(QtCore.QSize(200, 40))
        icon1 = QtGui.QIcon()
        icon1.addPixmap(QtGui.QPixmap(&quot;:/my_pic/pic/图片.png&quot;), QtGui.QIcon.Normal, QtGui.QIcon.Off)
        self.pushButton_3.setIcon(icon1)
        self.pushButton_3.setObjectName(&quot;pushButton_3&quot;)
        self.gridLayout.addWidget(self.pushButton_3, 4, 0, 1, 1)
        self.pushButton_5 = QtWidgets.QPushButton(self.centralWidget)
        self.pushButton_5.setStyleSheet(button_style)
        self.pushButton_5.setMinimumSize(QtCore.QSize(200, 40))
        icon2 = QtGui.QIcon()
        icon2.addPixmap(QtGui.QPixmap(&quot;:/my_pic/pic/视频.png&quot;), QtGui.QIcon.Normal, QtGui.QIcon.Off)
        self.pushButton_5.setIcon(icon2)
        self.pushButton_5.setObjectName(&quot;pushButton_5&quot;)
        self.gridLayout.addWidget(self.pushButton_5, 4, 2, 1, 1)
        self.line_2 = QtWidgets.QFrame(self.centralWidget)
        self.line_2.setFrameShape(QtWidgets.QFrame.HLine)
        self.line_2.setFrameShadow(QtWidgets.QFrame.Sunken)
        self.line_2.setObjectName(&quot;line_2&quot;)
        self.gridLayout.addWidget(self.line_2, 3, 0, 1, 3)
        self.pushButton_4 = QtWidgets.QPushButton(self.centralWidget)
        self.pushButton_4.setStyleSheet(button_style)
        self.pushButton_4.setMinimumSize(QtCore.QSize(200, 40))
        icon3 = QtGui.QIcon()
        icon3.addPixmap(QtGui.QPixmap(&quot;:/my_pic/pic/下载 绿色.png&quot;), QtGui.QIcon.Normal, QtGui.QIcon.Off)
        self.pushButton_4.setIcon(icon3)
        self.pushButton_4.setObjectName(&quot;pushButton_4&quot;)
        self.gridLayout.addWidget(self.pushButton_4, 4, 1, 1, 1)
        MainWindow.setCentralWidget(self.centralWidget)

        self.retranslateUi(MainWindow)
        QtCore.QMetaObject.connectSlotsByName(MainWindow)

    def retranslateUi(self, MainWindow):
        _translate = QtCore.QCoreApplication.translate
        MainWindow.setWindowTitle(_translate(&quot;MainWindow&quot;, &quot;AI京剧换脸&quot;))
        self.pushButton_3.setText(_translate(&quot;MainWindow&quot;, &quot;加载图像&quot;))
        self.pushButton_5.setText(_translate(&quot;MainWindow&quot;, &quot;加载视频&quot;))
        self.pushButton_4.setText(_translate(&quot;MainWindow&quot;, &quot;保存图像&quot;))
import my_pic_rc


if __name__ == &quot;__main__&quot;:
    import sys
    app = QtWidgets.QApplication(sys.argv)
    MainWindow = QtWidgets.QMainWindow()
    ui = Ui_MainWindow()
    ui.setupUi(MainWindow)
    MainWindow.show()
    sys.exit(app.exec_())

</code></pre>

<p>按照第6章和第7章的打包方式，打包安装后的运行效果：</p>
<p>查看在电脑的安装情况</p>
<div align=center>
<img src="../img/ch10/p7.png" /> 
</div>

<p><br></p>
<div align=center>
<img src="../img/ch10/p8.png" /> 
</div>

<p><br></p>
<p>运行：</p>
<div align=center>
<img src="../img/ch10/p9.png" /> 
</div>

<p><br></p>
<div align=center>
<img src="../img/ch10/p10.png" /> 
</div>

<p><br></p>
<div align=center>
<img src="../img/ch10/p11.png" /> 
</div>

<p><br></p>
<div align=center>
<img src="../img/ch10/p12.png" /> 
</div>

<p><br></p>
<div align=center>
<img src="../img/ch10/p13.png" /> 
</div>

<p><br></p>
<p>保存的图片：</p>
<div align=center>
<img src="../img/ch10/p14.jpg" /> 
</div>

<p><br></p>
<div align=center>
<img src="../img/ch10/p15.jpg" /> 
</div>

<p><br></p>
<div align=center>
<img src="../img/ch10/p16.jpg" /> 
</div>

<p><br></p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="../chapter9/" class="btn btn-neutral" title="第九章 buildozer Android打包基于kivymd的涂鸦画板项目"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/DataXujing/create_apps_in_kivy/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../chapter9/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js"></script>
      <script src="../search/require.js"></script>
      <script src="../search/search.js"></script>

</body>
</html>
